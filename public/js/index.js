let data = [
  {
    NR: 1,
    NOME: 'ANUAR SHUNNAK',
    VEZES: 2,
    VALOR: 360,
    PAGO: 360,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 2,
    NOME: 'ANDREIA ',
    VEZES: 1,
    VALOR: 245,
    PAGO: 245,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 3,
    NOME: 'ALETEIA SELONK',
    VEZES: 2,
    VALOR: 360,
    PAGO: 360,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 4,
    NOME: 'ANNA RITA PINTO M BETHGE',
    VEZES: 2,
    VALOR: 360,
    PAGO: 360,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 5,
    NOME: 'BARBARA PEUKERT',
    VEZES: 2,
    VALOR: 440,
    PAGO: 440,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 6,
    NOME: 'BRENDA RIGON',
    VEZES: 2,
    VALOR: 460,
    PAGO: 460,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 7,
    NOME: 'BIANCA SARUBI',
    VEZES: 2,
    VALOR: 460,
    PAGO: 460,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 8,
    NOME: 'CESAR BURMANN',
    VEZES: 2,
    VALOR: 460,
    PAGO: 460,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 9,
    NOME: 'CLAUDIA TREVISAN',
    VEZES: 1,
    VALOR: 215,
    PAGO: 215,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 10,
    NOME: 'CRISTIANE DUSSIN',
    VEZES: 2,
    VALOR: 460,
    PAGO: 460,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 11,
    NOME: 'DACILA',
    VEZES: 2,
    VALOR: 460,
    PAGO: 565,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: 'mais 2 aulas anteriores'
  },
  {
    NR: 12,
    NOME: 'DAIANE SCHIMIDT',
    VEZES: 1,
    VALOR: 245,
    PAGO: 205,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 13,
    NOME: 'DANIELLI MARIN',
    VEZES: 2,
    VALOR: 460,
    PAGO: 460,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 14,
    NOME: 'ELISA IKEDA',
    VEZES: 2,
    VALOR: 400,
    PAGO: 400,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 15,
    NOME: 'ELISABETH GOLDSZTEIN',
    VEZES: 2,
    VALOR: 360,
    PAGO: 360,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 16,
    NOME: 'Fabiola',
    VEZES: 1,
    VALOR: 245,
    PAGO: 350,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: 'cinco aulas'
  },
  {
    NR: 17,
    NOME: 'FERNANDO SCHWARTZMANN',
    VEZES: 1,
    VALOR: 245,
    PAGO: 245,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 18,
    NOME: 'FERNANDA OLIVEIRA',
    VEZES: 2,
    VALOR: 360,
    PAGO: 360,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 19,
    NOME: 'GILBERTO PADILHA TREVISAN',
    VEZES: 2,
    VALOR: 460,
    PAGO: 460,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 20,
    NOME: 'IEDA FREIRE LEDUR',
    VEZES: 2,
    VALOR: 460,
    PAGO: 705,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 21,
    NOME: 'ILDA FUENTES',
    VEZES: 2,
    VALOR: 360,
    PAGO: 360,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 22,
    NOME: 'JANE OLIVEIRA',
    VEZES: 2,
    VALOR: 360,
    PAGO: 405,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 23,
    NOME: 'JANICE KRUSE',
    VEZES: 2,
    VALOR: 360,
    PAGO: 360,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 24,
    NOME: 'JOSEFA LOSADA VALE',
    VEZES: 2,
    VALOR: 460,
    PAGO: 520,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: 'Camiseta'
  },
  {
    NR: 25,
    NOME: 'LETÍCIA DALPIAN',
    VEZES: 2,
    VALOR: 460,
    PAGO: 1060,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: 'out nov e liberação'
  },
  {
    NR: 26,
    NOME: 'LUCIANA LEDUR',
    VEZES: 2,
    VALOR: 460,
    PAGO: 460,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 27,
    NOME: 'LUCIANA P',
    VEZES: 1,
    VALOR: 245,
    PAGO: 0,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 28,
    NOME: 'LUCIANA WERNER',
    VEZES: 2,
    VALOR: 460,
    PAGO: 460,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 29,
    NOME: 'LUCIANO MARCHETO',
    VEZES: 2,
    VALOR: 460,
    PAGO: 460,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 30,
    NOME: 'MARCO ANTONIO',
    VEZES: 1,
    VALOR: 245,
    PAGO: 245,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 31,
    NOME: 'MAGDA MOURA',
    VEZES: 2,
    VALOR: 0,
    PAGO: 0,
    DATA: '',
    ACTIVE: false,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 32,
    NOME: 'MARA NÚBIA',
    VEZES: 1,
    VALOR: 0,
    PAGO: 0,
    DATA: '',
    ACTIVE: false,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 33,
    NOME: 'MARCIA VALIENTE FERREIRA',
    VEZES: 1,
    VALOR: 0,
    PAGO: 0,
    DATA: '',
    ACTIVE: false,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 34,
    NOME: 'MARIA MARCELA MARIM',
    VEZES: 1,
    VALOR: 245,
    PAGO: 245,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  ,
  {
    NR: 35,
    NOME: 'MARCELLE PUJOL',
    VEZES: 1,
    VALOR: 210,
    PAGO: 210,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 36,
    NOME: 'MARIA CAROLINA CAMPANI',
    VEZES: 1,
    VALOR: 245,
    PAGO: 305,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: 'uma aula a mais'
  },
  {
    NR: 37,
    NOME: 'MARIA CRISTINA DA SILVA ESCOTO',
    VEZES: 2,
    VALOR: 460,
    PAGO: 540,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: 'mais metade do mes de dez'
  },
  {
    NR: 38,
    NOME: 'MARIA DO HORTO',
    VEZES: 2,
    VALOR: 400,
    PAGO: 400,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 39,
    NOME: 'MARIANA',
    VEZES: 1,
    VALOR: 320,
    PAGO: 280,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 40,
    NOME: 'MIGUEL JORGE',
    VEZES: 1,
    VALOR: 245,
    PAGO: 306,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: 'um aula a mais'
  },
  {
    NR: 41,
    NOME: 'OLIVIA FISCHER',
    VEZES: 2,
    VALOR: 460,
    PAGO: 830,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: 'mes anterior e nov'
  },
  {
    NR: 42,
    NOME: 'PAULA DALPIAN',
    VEZES: 2,
    VALOR: 460,
    PAGO: 0,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 43,
    NOME: 'RAFAEL B CLARO',
    VEZES: 1,
    VALOR: 245,
    PAGO: 245,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 44,
    NOME: 'RENATO ROSA',
    VEZES: 1,
    VALOR: 245,
    PAGO: 245,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 45,
    NOME: 'RENATO SCHWARTZMANN',
    VEZES: 1,
    VALOR: 245,
    PAGO: 245,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 46,
    NOME: 'RODRIGO LORETO CURTO',
    VEZES: 1,
    VALOR: 360,
    PAGO: 360,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  /*{
    NR: 47,
    NOME: 'ROBERTA',
    VEZES: 2,
    VALOR: 420,
    PAGO: 420,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },*/
  {
    NR: 47,
    NOME: 'SILVANE LORENZONI SESTI',
    VEZES: 2,
    VALOR: 460,
    PAGO: 460,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 48,
    NOME: 'SAMANTHA NASCIMENTO PORTO',
    VEZES: 2,
    VALOR: 420,
    PAGO: 420,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 49,
    NOME: 'SOLANGE SCHWENGBER',
    VEZES: 2,
    VALOR: 460,
    PAGO: 460,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 50,
    NOME: 'TATIANE SOLFER',
    VEZES: 1,
    VALOR: 240,
    PAGO: 240,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  },
  {
    NR: 51,
    NOME: 'TEREZINHA MILANESI',
    VEZES: 2,
    VALOR: 460,
    PAGO: 460,
    DATA: '',
    ACTIVE: true,
    TYPE: 'cheque',
    OBS: ''
  }
];

const months = [
  {
    abr: 'Jan',
    label: 'Janeiro'
  },
  {
    abr: 'Fev',
    label: 'Feveiro'
  },
  {
    abr: 'Mar',
    label: 'Março'
  },
  {
    abr: 'Abr',
    label: 'Abril'
  },
  {
    abr: 'Mai',
    label: 'Maio'
  },
  {
    abr: 'Jun',
    label: 'Junho'
  },
  {
    abr: 'Jul',
    label: 'Julho'
  },
  {
    abr: 'Ago',
    label: 'Agosto'
  },
  {
    abr: 'Set',
    label: 'Setembro'
  },
  {
    abr: 'Out',
    label: 'Outubro'
  },
  {
    abr: 'Nov',
    label: 'Novembro'
  },
  {
    abr: 'Dez',
    label: 'Dezembro'
  }
];

//variable inits
const keyBD = 'paymentsKaizen',
  tableContent = document.querySelector('.il-list'),
  btnSave = document.getElementById('btnSave'),
  btnCancel = document.getElementById('btnCancel'),
  pay = document.getElementById('pay'),
  dt = document.getElementById('dt'),
  type = document.getElementById('type'),
  modal = document.querySelector('.il-modal--container'),
  month = document.querySelector('.il-month');

let currentMonth = null,
  currentStudent = null,
  currentStudentIndex = null;

const main = {
  getStorage: () => {
    return localforage
      .getItem(keyBD)
      .then(res => {
        return res;
      })
      .then(value => {
        return value;
      });
  },
  getStudent: key => {
    return data[key];
  },
  getId: () => {
    const maxMin = (max, min) => {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    };
    let length = 8;
    let timestamp = +new Date();
    var ts = timestamp.toString();
    var parts = ts.split('').reverse();
    var id = '';
    for (var i = 0; i < length; ++i) {
      var index = maxMin(0, parts.length - 1);
      id += parts[index];
    }
    return id;
  },
  updateData: (key, student) => {
    data[key] = student;
  },
  createData: schema => {
    localforage
      .setItem(keyBD, schema)
      .then(value => {
        // Do other things once the value has been saved.
        alert('Dados armazenados com sucesso!');
      })
      .catch(err => {
        // This code runs if there were any errors
        alert('Algum erro foi gerado. Sorry!!!');
        console.log(err);
      });
  },
  setContents: () => {
    let row = '',
      trClass = '';
    data.forEach((item, index) => {
      if (!item.ACTIVE) {
        trClass = 'il-inactive';
      } else {
        trClass = '';
      }
      row += `
            <tr class="${trClass}">
              <td>${item.NR}</td>
              <td>${item.NOME}</td>
              <td>${item.VEZES}</td>
              <td>${item.VALOR}</td>
              <td>${item.PAGO}</td>
              <td>${item.DATA}</td>
              <td>${item.TYPE}</td>
              <td>${item.OBS}</td>
              <td><span title="receber" class="il-add" id="add_${index}">+</span></td>
            </tr>
    `;
    });
    row += `
        <tr>
          <td colspan="6" class="sum">Total previsto <span id="sum"></span></td>
          <td colspan="7" class="total">Total pago<span id="total"></span></td>
        </tr>`;
    return row;
  },
  setStorage: schema => {
    localforage.setDriver([
      localforage.INDEXEDDB,
      localforage.WEBSQL,
      localforage.LOCALSTORAGE
    ]);
  },
  setStudent: (key, student) => {
    data[key] = student;
    window.localStorage.setItem('currentStudent', JSON.stringify(student));
    window.localStorage.setItem('currentStudentIndex', JSON.stringify(key));
  },
  countStorage: () => {
    storage(function(err, count) {}); // count == 2
  },
  deleteStorage: () => {
    localforage.clear();
  },
  sum: () => {
    let total = 0;
    data.forEach(pay => {
      total += parseInt(pay.VALOR);
    });
    return total;
  },
  total: () => {
    let sum = 0;
    data.forEach(pay => {
      if (pay.PAGO != 0) {
        sum += parseInt(pay.PAGO);
      }
    });
    return sum;
  }
};

const checkStudent = student => {
  try {
    let contents = student.contents;

    let search = contents.findIndex(element => {
      return element.NOME === currentStudent.NOME;
    });
    if (search >= 0) {
      return true;
    }
    return false;
  } catch (error) {
    console.log(error);
  }
};

//prepare data to save
const getSchema = () => {
  let contents = {
    NR: currentStudent.NR,
    NOME: currentStudent.NOME,
    VEZES: currentStudent.VEZES,
    VALOR: currentStudent.VALOR,
    PAGO: currentStudent.PAGO,
    DATA: currentStudent.DATA,
    ACTIVE: currentStudent.ACTIVE,
    TYPE: currentStudent.TYPE,
    OBS: currentStudent.OBS
  };
  let schema = {
    id: main.getId(),
    monthCurrent: getMonth(),
    contents: [contents]
  };
  return schema;
};

//add event show
const addEventShow = () => {
  const btnAdd = document.querySelectorAll('.il-add');
  const Payed = document.querySelector('.il-payed');
  btnAdd.forEach((btn, index) => {
    btn.addEventListener('click', () => {
      currentStudentIndex = index;
      currentStudent = main.getStudent(index);
      Payed.innerHTML = currentStudent.NOME;
      modal.classList.add('show');
    });
  });
};

//add event Save
const addEventSave = () => {
  btnSave.addEventListener('click', () => {
    let payValue = pay.value,
      dtValue = dt.value,
      typeValue = type.value;
    currentStudent.PAGO = parseInt(payValue);
    currentStudent.DATA = dtValue;
    currentStudent.TYPE = typeValue;
    //make new data
    main.setStudent(currentStudentIndex, currentStudent);
    modal.classList.remove('show');
    localforage
      .getItem(keyBD)
      .then(res => {
        if (res) {
          let filter = res.findIndex(item => {
            return item.monthCurrent == getMonth();
          });
          if (filter >= 0) {
            if (checkStudent(res[filter])) {
              alert('student aready exist');
            } else {
              //same month and new student to current month
              res[filter].contents.push(currentStudent);
              main.createData(res);
              //update data

              main.updateData(currentStudentIndex, currentStudent);
              load();
            }
          } else {
            //first insertion another month
            let schema = getSchema();
            res.pusch(schema);
            main.createData(res);
            //update data

            main.updateData(currentStudentIndex, currentStudent);
            load();
          }
        } else {
          //first insertion
          let schema = getSchema();
          main.createData([schema]);
          //update data

          main.updateData(currentStudentIndex, currentStudent);
          load();
        }
      })
      .then(value => {
        return value;
      });
  });
  return;
};

//add cancel
const addEventCancel = () => {
  btnCancel.addEventListener('click', () => {
    currentStudent = null;
    currentStudentIndex = null;
    modal.classList.remove('show');
    pay.value = 0;
    dt.value = '';
    typeValue = '';
  });
};

//load table
const load = () => {
  currentStudent = window.localStorage.getItem('currentStudent')
    ? JSON.parse(window.localStorage.getItem('currentStudent'))
    : null;
  //init variables
  const trContents = main.setContents();
  tableContent.innerHTML = trContents;
  const Sum = document.getElementById('sum');
  const Total = document.getElementById('total');
  Sum.innerHTML = main.sum();
  Total.innerHTML = main.total();
  //addEvents
  addEventShow();
  addEventSave();
  addEventCancel();
};

//restart table
const reload = () => {
  const trContents = main.setContents();
  tableContent.innerHTML = trContents;
  const Sum = document.getElementById('sum');
  const Total = document.getElementById('total');
  Sum.innerHTML = main.sum();
  Total.innerHTML = main.total();
};

//prepare store
const getMonth = () => {
  let today = new Date();
  return today.getMonth();
};

//start app
function start() {
  //initialize localforage
  currentMonth = getMonth();
  month.innerHTML = months[currentMonth].label;
  main.setStorage();
  main
    .getStorage()
    .then(res => {
      if (res) {
        let filter = res.findIndex(item => {
          return item.monthCurrent == currentMonth;
        });

        if (filter >= 0) {
          let dataTemp = data;
          let students = res[filter].contents;
          students.forEach(student => {
            let key = dataTemp.findIndex(element => {
              return element.NR == student.NR;
            });

            if (key >= 0) {
              main.updateData(key, student);
            }
          });
        }
      }
    })
    .catch(err => {
      console.log(err);
    });
  //show list
  load();
}

/**Document ready start app */
document.addEventListener('DOMContentLoaded', start, false);
